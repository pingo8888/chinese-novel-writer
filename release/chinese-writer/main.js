/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var R=Object.defineProperty;var Q=Object.getOwnPropertyDescriptor;var J=Object.getOwnPropertyNames;var _=Object.prototype.hasOwnProperty;var Y=(S,l)=>()=>(S&&(l=S(S=0)),l);var G=(S,l)=>{for(var t in l)R(S,t,{get:l[t],enumerable:!0})},X=(S,l,t,e)=>{if(l&&typeof l=="object"||typeof l=="function")for(let i of J(l))!_.call(S,i)&&i!==t&&R(S,i,{get:()=>l[i],enumerable:!(e=Q(l,i))||e.enumerable});return S};var Z=S=>X(R({},"__esModule",{value:!0}),S);var K={};G(K,{ConfirmModal:()=>k,TextInputModal:()=>E});var j,E,k,O=Y(()=>{j=require("obsidian"),E=class extends j.Modal{constructor(t,e,i,n,r){super(t);this.submitted=!1;this.title=e,this.placeholder=i,this.defaultValue=n,this.onSubmit=r}onOpen(){let{contentEl:t}=this,e=t.closest(".modal");e&&(e.style.minHeight="auto",e.style.height="auto",e.style.maxWidth="400px",e.style.width="90%"),t.style.padding="1em";let i=t.createEl("h2",{text:this.title});i.style.marginTop="0",i.style.marginBottom="0.8em",i.style.fontSize="1.2em";let n=t.createEl("input",{type:"text",placeholder:this.placeholder,value:this.defaultValue});n.style.width="100%",n.style.marginBottom="1em",n.style.padding="0.5em",n.focus(),n.select();let r=t.createDiv();r.style.display="flex",r.style.justifyContent="flex-end",r.style.gap="0.5em",r.createEl("button",{text:"\u53D6\u6D88"}).addEventListener("click",()=>{this.close()});let a=r.createEl("button",{text:"\u786E\u5B9A",cls:"mod-cta"}),o=()=>{if(this.submitted)return;this.submitted=!0;let h=n.value;this.close(),setTimeout(()=>{this.onSubmit(h)},10)};a.addEventListener("click",o),n.addEventListener("keydown",h=>{h.key==="Enter"?o():h.key==="Escape"&&this.close()})}onClose(){let{contentEl:t}=this;t.empty()}},k=class extends j.Modal{constructor(l,t,e,i){super(l),this.title=t,this.message=e,this.onConfirm=i}onOpen(){let{contentEl:l}=this,t=l.closest(".modal");t&&(t.style.minHeight="auto",t.style.height="auto",t.style.maxWidth="400px",t.style.width="90%"),l.style.padding="1em";let e=l.createEl("h2",{text:this.title});e.style.marginTop="0",e.style.marginBottom="0.8em",e.style.fontSize="1.2em";let i=l.createEl("p",{text:this.message});i.style.marginBottom="1em";let n=l.createDiv();n.style.display="flex",n.style.justifyContent="flex-end",n.style.gap="0.5em",n.style.marginTop="0.5em",n.createEl("button",{text:"\u53D6\u6D88"}).addEventListener("click",()=>{this.close()}),n.createEl("button",{text:"\u786E\u5B9A",cls:"mod-warning"}).addEventListener("click",()=>{this.close(),this.onConfirm()})}onClose(){let{contentEl:l}=this;l.empty()}}});var tt={};G(tt,{default:()=>$});module.exports=Z(tt);var F=require("obsidian");var x=require("obsidian"),D={folderMappings:[],highlightStyle:{mode:"all",backgroundColor:"#FFFFFF00",borderStyle:"dotted",borderWidth:2,borderColor:"#4A86E9",fontWeight:"normal",fontStyle:"normal",color:"#4A86E9"},highlightPreviewStyle:{width:300,height:340,maxBodyLines:12},punctuationCheck:{enabled:!1,comma:!0,period:!0,colon:!0,semicolon:!0,exclamation:!0,question:!0,doubleQuote:!0,singleQuote:!0},openInNewTab:!0},W=class extends x.PluginSettingTab{constructor(t,e){super(t,e);this.isAddingMapping=!1;this.plugin=e}display(){let{containerEl:t}=this,e=async()=>{await this.plugin.saveSettings(),this.refreshEditorHighlight()},i=[],n=s=>{for(let a of i)a.setDisabled(s)};t.empty(),t.createEl("h2",{text:"\u4E2D\u6587\u5199\u4F5C\u63D2\u4EF6\u8BBE\u7F6E"}),t.createEl("h3",{text:"\u6587\u4EF6\u5939\u5BF9\u5E94\u5173\u7CFB"}),t.createEl("p",{text:"\u914D\u7F6E\u5C0F\u8BF4\u5E93\u548C\u8BBE\u5B9A\u5E93\u7684\u5BF9\u5E94\u5173\u7CFB\u3002\u5728\u5C0F\u8BF4\u5E93\u6587\u4EF6\u6253\u5F00\u65F6\uFF0C\u4F1A\u663E\u793A\u5BF9\u5E94\u8BBE\u5B9A\u5E93\u7684\u5185\u5BB9\uFF0C\u5E76\u9AD8\u4EAE\u5173\u952E\u5B57\u3002",cls:"setting-item-description"});let r=t.createDiv({cls:"folder-mappings-container"});this.renderMappings(r),new x.Setting(t).setName("\u6DFB\u52A0\u65B0\u5BF9\u5E94\u5173\u7CFB").addButton(s=>s.setButtonText("\u6DFB\u52A0").setCta().onClick(()=>{this.isAddingMapping||this.addNewMapping()})),t.createEl("h3",{text:"\u5173\u952E\u5B57\u9AD8\u4EAE\u6837\u5F0F"}),new x.Setting(t).setName("\u9AD8\u4EAE\u6A21\u5F0F").setDesc("\u9009\u62E9\u5173\u952E\u5B57\u7684\u9AD8\u4EAE\u65B9\u5F0F").addDropdown(s=>s.addOption("first","\u9996\u6B21\u9AD8\u4EAE").addOption("all","\u5168\u90E8\u9AD8\u4EAE").setValue(this.plugin.settings.highlightStyle.mode).onChange(async a=>{this.plugin.settings.highlightStyle.mode=a,await this.plugin.saveSettings(),this.refreshEditorHighlight()})),new x.Setting(t).setName("\u80CC\u666F\u8272").setDesc("\u9AD8\u4EAE\u5173\u952E\u5B57\u7684\u80CC\u666F\u989C\u8272\uFF08\u652F\u63018\u4F4DHEX\uFF0C\u5982 #FFFFFF00\uFF0C\u6700\u540E\u4E24\u4F4D\u4E3A\u900F\u660E\u5EA6\uFF09").addText(s=>s.setPlaceholder("#FFFFFF00").setValue(this.plugin.settings.highlightStyle.backgroundColor).onChange(async a=>{this.plugin.settings.highlightStyle.backgroundColor=a,await this.plugin.saveSettings(),this.updateHighlightStyles()})),new x.Setting(t).setName("\u4E0B\u5212\u7EBF\u6837\u5F0F").setDesc("\u9AD8\u4EAE\u5173\u952E\u5B57\u7684\u4E0B\u5212\u7EBF\u6837\u5F0F").addDropdown(s=>s.addOption("solid","\u5B9E\u7EBF").addOption("dashed","\u865A\u7EBF").addOption("dotted","\u70B9\u7EBF").addOption("double","\u53CC\u7EBF").addOption("wavy","\u6CE2\u6D6A\u7EBF").setValue(this.plugin.settings.highlightStyle.borderStyle).onChange(async a=>{this.plugin.settings.highlightStyle.borderStyle=a,await this.plugin.saveSettings(),this.updateHighlightStyles()})),new x.Setting(t).setName("\u4E0B\u5212\u7EBF\u7C97\u7EC6").setDesc("\u9AD8\u4EAE\u5173\u952E\u5B57\u7684\u4E0B\u5212\u7EBF\u7C97\u7EC6\uFF080-10\u50CF\u7D20\uFF09").addSlider(s=>s.setLimits(0,10,1).setValue(this.plugin.settings.highlightStyle.borderWidth).setDynamicTooltip().onChange(async a=>{this.plugin.settings.highlightStyle.borderWidth=a,await this.plugin.saveSettings(),this.updateHighlightStyles()})),new x.Setting(t).setName("\u4E0B\u5212\u7EBF\u989C\u8272").setDesc("\u9AD8\u4EAE\u5173\u952E\u5B57\u7684\u4E0B\u5212\u7EBF\u989C\u8272").addText(s=>s.setPlaceholder("#4A86E9").setValue(this.plugin.settings.highlightStyle.borderColor).onChange(async a=>{this.plugin.settings.highlightStyle.borderColor=a,await this.plugin.saveSettings(),this.updateHighlightStyles()})),new x.Setting(t).setName("\u5B57\u4F53\u7C97\u7EC6").setDesc("\u9AD8\u4EAE\u5173\u952E\u5B57\u7684\u5B57\u4F53\u7C97\u7EC6").addDropdown(s=>s.addOption("normal","\u6B63\u5E38").addOption("bold","\u7C97\u4F53").setValue(this.plugin.settings.highlightStyle.fontWeight).onChange(async a=>{this.plugin.settings.highlightStyle.fontWeight=a,await this.plugin.saveSettings(),this.updateHighlightStyles()})),new x.Setting(t).setName("\u5B57\u4F53\u6837\u5F0F").setDesc("\u9AD8\u4EAE\u5173\u952E\u5B57\u7684\u5B57\u4F53\u6837\u5F0F").addDropdown(s=>s.addOption("normal","\u6B63\u5E38").addOption("italic","\u659C\u4F53").setValue(this.plugin.settings.highlightStyle.fontStyle).onChange(async a=>{this.plugin.settings.highlightStyle.fontStyle=a,await this.plugin.saveSettings(),this.updateHighlightStyles()})),new x.Setting(t).setName("\u6587\u5B57\u989C\u8272").setDesc("\u9AD8\u4EAE\u5173\u952E\u5B57\u7684\u6587\u5B57\u989C\u8272\uFF08\u652F\u63018\u4F4DHEX\uFF0C\u5982 #4A86E9ff\uFF0Cinherit\u8868\u793A\u7EE7\u627F\u539F\u6709\u989C\u8272\uFF09").addText(s=>s.setPlaceholder("#4A86E9").setValue(this.plugin.settings.highlightStyle.color).onChange(async a=>{this.plugin.settings.highlightStyle.color=a,await this.plugin.saveSettings(),this.updateHighlightStyles()})),t.createEl("h3",{text:"\u5E38\u89C1\u6807\u70B9\u68C0\u6D4B"}),new x.Setting(t).setName("\u542F\u7528\u5E38\u89C1\u6807\u70B9\u68C0\u6D4B").setDesc("\u4EC5\u5728\u5DF2\u914D\u7F6E\u5C0F\u8BF4\u5E93\u4E2D\u7684 Markdown \u6587\u4EF6\u5185\u8FDB\u884C\u68C0\u6D4B").addToggle(s=>s.setValue(this.plugin.settings.punctuationCheck.enabled).onChange(async a=>{this.plugin.settings.punctuationCheck.enabled=a,await e(),n(!a)})),new x.Setting(t).setName("\u68C0\u6D4B\u82F1\u6587\u9017\u53F7\uFF08,\uFF09").addToggle(s=>{i.push(s),s.setValue(this.plugin.settings.punctuationCheck.comma).setDisabled(!this.plugin.settings.punctuationCheck.enabled).onChange(async a=>{this.plugin.settings.punctuationCheck.comma=a,await e()})}),new x.Setting(t).setName("\u68C0\u6D4B\u82F1\u6587\u53E5\u53F7\uFF08.\uFF09").addToggle(s=>{i.push(s),s.setValue(this.plugin.settings.punctuationCheck.period).setDisabled(!this.plugin.settings.punctuationCheck.enabled).onChange(async a=>{this.plugin.settings.punctuationCheck.period=a,await e()})}),new x.Setting(t).setName("\u68C0\u6D4B\u82F1\u6587\u5192\u53F7\uFF08:\uFF09").addToggle(s=>{i.push(s),s.setValue(this.plugin.settings.punctuationCheck.colon).setDisabled(!this.plugin.settings.punctuationCheck.enabled).onChange(async a=>{this.plugin.settings.punctuationCheck.colon=a,await e()})}),new x.Setting(t).setName("\u68C0\u6D4B\u82F1\u6587\u5206\u53F7\uFF08;\uFF09").addToggle(s=>{i.push(s),s.setValue(this.plugin.settings.punctuationCheck.semicolon).setDisabled(!this.plugin.settings.punctuationCheck.enabled).onChange(async a=>{this.plugin.settings.punctuationCheck.semicolon=a,await e()})}),new x.Setting(t).setName("\u68C0\u6D4B\u82F1\u6587\u611F\u53F9\u53F7\uFF08!\uFF09").addToggle(s=>{i.push(s),s.setValue(this.plugin.settings.punctuationCheck.exclamation).setDisabled(!this.plugin.settings.punctuationCheck.enabled).onChange(async a=>{this.plugin.settings.punctuationCheck.exclamation=a,await e()})}),new x.Setting(t).setName("\u68C0\u6D4B\u82F1\u6587\u95EE\u53F7\uFF08?\uFF09").addToggle(s=>{i.push(s),s.setValue(this.plugin.settings.punctuationCheck.question).setDisabled(!this.plugin.settings.punctuationCheck.enabled).onChange(async a=>{this.plugin.settings.punctuationCheck.question=a,await e()})}),new x.Setting(t).setName("\u68C0\u6D4B\u53CC\u5F15\u53F7").setDesc('\u68C0\u6D4B\u82F1\u6587\u53CC\u5F15\u53F7\uFF08"\uFF09\u4E0E\u4E2D\u6587\u53CC\u5F15\u53F7\uFF08\u201C\u201D\uFF09\u914D\u5BF9\u9519\u8BEF').addToggle(s=>{i.push(s),s.setValue(this.plugin.settings.punctuationCheck.doubleQuote).setDisabled(!this.plugin.settings.punctuationCheck.enabled).onChange(async a=>{this.plugin.settings.punctuationCheck.doubleQuote=a,await e()})}),new x.Setting(t).setName("\u68C0\u6D4B\u5355\u5F15\u53F7").setDesc("\u68C0\u6D4B\u82F1\u6587\u5355\u5F15\u53F7\uFF08'\uFF09\u4E0E\u4E2D\u6587\u5355\u5F15\u53F7\uFF08\u2018\u2019\uFF09\u914D\u5BF9\u9519\u8BEF").addToggle(s=>{i.push(s),s.setValue(this.plugin.settings.punctuationCheck.singleQuote).setDisabled(!this.plugin.settings.punctuationCheck.enabled).onChange(async a=>{this.plugin.settings.punctuationCheck.singleQuote=a,await e()})}),t.createEl("h3",{text:"\u9AD8\u4EAE\u60AC\u505C\u9884\u89C8"}),new x.Setting(t).setName("\u9884\u89C8\u680F\u5BBD\u5EA6").setDesc("\u60AC\u505C\u9884\u89C8\u680F\u5BBD\u5EA6\uFF08\u50CF\u7D20\uFF09").addSlider(s=>s.setLimits(240,720,20).setValue(this.plugin.settings.highlightPreviewStyle.width).setDynamicTooltip().onChange(async a=>{this.plugin.settings.highlightPreviewStyle.width=a,await this.plugin.saveSettings()})),new x.Setting(t).setName("\u9884\u89C8\u680F\u9AD8\u5EA6").setDesc("\u60AC\u505C\u9884\u89C8\u680F\u6700\u5927\u9AD8\u5EA6\uFF08\u50CF\u7D20\uFF09").addSlider(s=>s.setLimits(160,800,20).setValue(this.plugin.settings.highlightPreviewStyle.height).setDynamicTooltip().onChange(async a=>{this.plugin.settings.highlightPreviewStyle.height=a,await this.plugin.saveSettings()})),new x.Setting(t).setName("\u4E0B\u65B9\u5185\u5BB9\u6700\u591A\u663E\u793A\u884C\u6570").setDesc("\u8D85\u8FC7\u8BE5\u884C\u6570\u65F6\u663E\u793A\u6EDA\u52A8\u6761").addSlider(s=>s.setLimits(3,50,1).setValue(this.plugin.settings.highlightPreviewStyle.maxBodyLines).setDynamicTooltip().onChange(async a=>{this.plugin.settings.highlightPreviewStyle.maxBodyLines=a,await this.plugin.saveSettings()})),t.createEl("h3",{text:"\u6587\u4EF6\u6253\u5F00\u884C\u4E3A"}),new x.Setting(t).setName("\u5728\u65B0\u6807\u7B7E\u9875\u6253\u5F00").setDesc("\u901A\u8FC7\u63D2\u4EF6\u5185\u76F8\u5173\u529F\u80FD\u6253\u5F00\u6216\u65B0\u5EFA\u6587\u4EF6\u65F6\uFF0C\u662F\u5426\u5728\u65B0\u6807\u7B7E\u9875\u6253\u5F00\uFF08\u5DF2\u6253\u5F00\u5219\u590D\u7528\u73B0\u6709\u6807\u7B7E\uFF09").addToggle(s=>s.setValue(this.plugin.settings.openInNewTab).onChange(async a=>{this.plugin.settings.openInNewTab=a,await this.plugin.saveSettings()}))}renderMappings(t){if(t.empty(),this.plugin.settings.folderMappings.length===0){t.createEl("p",{text:"\u6682\u65E0\u5BF9\u5E94\u5173\u7CFB\uFF0C\u8BF7\u70B9\u51FB\u4E0B\u65B9\u6309\u94AE\u6DFB\u52A0\u3002",cls:"setting-item-description"});return}this.plugin.settings.folderMappings.forEach((e,i)=>{let n=`${e.novelFolder||"\u672A\u8BBE\u7F6E"} \u2192 ${e.settingFolder||"\u672A\u8BBE\u7F6E"}`;new x.Setting(t).setName(n).setClass("folder-mapping-item").addButton(r=>r.setButtonText("\u7F16\u8F91").onClick(async()=>{await this.editMapping(e)})).addButton(r=>r.setButtonText("\u5220\u9664").setWarning().onClick(async()=>{e.settingFolder&&await this.plugin.orderManager.removeFolderData(e.settingFolder),this.plugin.settings.folderMappings=this.plugin.settings.folderMappings.filter(s=>s.id!==e.id),await this.plugin.saveSettings(),await this.plugin.refreshView(),this.refreshEditorHighlight(),this.display()}))})}async editMapping(t){let{TextInputModal:e}=await Promise.resolve().then(()=>(O(),K)),i=t.settingFolder;new e(this.app,"\u7F16\u8F91\u5BF9\u5E94\u5173\u7CFB - \u6B65\u9AA4 1/2","\u8BF7\u8F93\u5165\u5C0F\u8BF4\u5E93\u8DEF\u5F84\uFF08\u76F8\u5BF9\u4E8E\u4ED3\u5E93\u6839\u76EE\u5F55\uFF09",t.novelFolder,async n=>{n.trim()&&setTimeout(()=>{new e(this.app,"\u7F16\u8F91\u5BF9\u5E94\u5173\u7CFB - \u6B65\u9AA4 2/2","\u8BF7\u8F93\u5165\u8BBE\u5B9A\u5E93\u8DEF\u5F84\uFF08\u76F8\u5BF9\u4E8E\u4ED3\u5E93\u6839\u76EE\u5F55\uFF09",t.settingFolder,async r=>{r.trim()&&(t.novelFolder=n.trim(),t.settingFolder=r.trim(),i&&await this.plugin.orderManager.removeFolderData(i),await this.plugin.saveSettings(),setTimeout(async()=>{await this.plugin.refreshView(),this.refreshEditorHighlight(),this.display()},50))}).open()},100)}).open()}async addNewMapping(){if(this.isAddingMapping)return;this.isAddingMapping=!0;let{TextInputModal:t}=await Promise.resolve().then(()=>(O(),K));new t(this.app,"\u6DFB\u52A0\u5BF9\u5E94\u5173\u7CFB - \u6B65\u9AA4 1/2","\u8BF7\u8F93\u5165\u5C0F\u8BF4\u5E93\u8DEF\u5F84\uFF08\u76F8\u5BF9\u4E8E\u4ED3\u5E93\u6839\u76EE\u5F55\uFF09","",async e=>{if(!e.trim()){this.isAddingMapping=!1;return}setTimeout(()=>{new t(this.app,"\u6DFB\u52A0\u5BF9\u5E94\u5173\u7CFB - \u6B65\u9AA4 2/2","\u8BF7\u8F93\u5165\u8BBE\u5B9A\u5E93\u8DEF\u5F84\uFF08\u76F8\u5BF9\u4E8E\u4ED3\u5E93\u6839\u76EE\u5F55\uFF09","",async i=>{if(!i.trim()){this.isAddingMapping=!1;return}let n={id:Date.now().toString(),novelFolder:e.trim(),settingFolder:i.trim()};this.plugin.settings.folderMappings.push(n),await this.plugin.saveSettings(),setTimeout(async()=>{await this.plugin.refreshView(),this.refreshEditorHighlight(),this.display(),this.isAddingMapping=!1},50)}).open()},100)}).open()}updateHighlightStyles(){this.plugin.highlightManager&&this.plugin.highlightManager.updateStyles()}refreshEditorHighlight(){this.plugin.highlightManager&&this.plugin.highlightManager.refreshCurrentEditor()}};var z=require("obsidian"),A=class{constructor(l){this.vault=l}async parseFolder(l){let t=[],e=this.vault.getAbstractFileByPath(l);if(!e||!(e instanceof z.TFile)){let n=this.vault.getMarkdownFiles().filter(r=>r.path.startsWith(l));for(let r of n){let s=await this.parseFile(r);s&&t.push(s)}}return t}async parseFile(l){if(l.extension!=="md")return null;let e=(await this.vault.read(l)).split(`
`),i=[],n=null,r=null;for(let s=0;s<e.length;s++){let a=e[s];if(!a)continue;let o=a.trim();o.startsWith("# ")&&!o.startsWith("## ")?(r&&n&&(n.h2List.push(r),r=null),n&&i.push(n),n={text:o.substring(2).trim(),lineNumber:s,h2List:[]}):o.startsWith("## ")&&!o.startsWith("### ")&&n?(r&&n.h2List.push(r),r={text:o.substring(3).trim(),lineNumber:s,content:[]}):r&&a&&o.length>0&&r.content.push(a)}return r&&n&&n.h2List.push(r),n&&i.push(n),{filePath:l.path,fileName:l.basename,h1List:i}}getMarkdownFilesInFolder(l){return this.vault.getMarkdownFiles().filter(e=>l===""?!0:e.path.startsWith(l+"/")||e.path===l)}};var b=require("obsidian");O();var C="chinese-writer-tree-view",N=class extends b.ItemView{constructor(t,e){super(t);this.treeData=[];this.allExpanded=!1;this.lastObservedActiveFilePath=null;this.currentSettingFolder=null;this.draggedNode=null;this.dropIndicator=null;this.insertBefore=!1;this.plugin=e}getViewType(){return C}getDisplayText(){return"\u4E2D\u6587\u5199\u4F5C"}getIcon(){return"book-type"}async onOpen(){var t,e;await this.refresh(),this.lastObservedActiveFilePath=(e=(t=this.getContextFile())==null?void 0:t.path)!=null?e:null,this.registerEvent(this.app.workspace.on("active-leaf-change",async i=>{var r,s;let n=this.lastObservedActiveFilePath;(i==null?void 0:i.view)instanceof b.MarkdownView&&(n=(s=(r=i.view.file)==null?void 0:r.path)!=null?s:null),n!==this.lastObservedActiveFilePath&&(this.lastObservedActiveFilePath=n,await this.smartUpdate())}))}async onClose(){this.removeDropIndicator()}async refresh(){let t=this.containerEl.children[1];if(!t)return;t.empty(),t.addClass("chinese-writer-view");let e=t.createDiv({cls:"chinese-writer-header"}),i=e.createDiv({cls:"chinese-writer-title"}),n=i.createSpan({cls:"chinese-writer-icon"});(0,b.setIcon)(n,"book-type");let r=this.getContextFile(),s="\u672A\u8BBE\u7F6E\u76EE\u5F55";if(r){let h=this.plugin.highlightManager.getSettingFolderForFile(r.path);h&&(s=this.getFolderDisplayName(h))}i.createSpan({text:s,cls:"chinese-writer-folder-name"});let a=e.createEl("button",{cls:"chinese-writer-toggle-btn"});(0,b.setIcon)(a,this.allExpanded?"list-chevrons-down-up":"list-chevrons-up-down"),a.setAttribute("aria-label","\u5C55\u5F00/\u6298\u53E0\u5168\u90E8"),a.addEventListener("click",()=>{this.toggleAllNodes()});let o=t.createDiv({cls:"chinese-writer-tree-container"});o.addEventListener("contextmenu",h=>{let c=h.target;(c.classList.contains("chinese-writer-tree-container")||c.classList.contains("chinese-writer-tree")||c.classList.contains("chinese-writer-empty"))&&(h.preventDefault(),h.stopPropagation(),this.showEmptyAreaContextMenu(h))}),await this.loadData(),this.renderTree(o,this.treeData)}async smartUpdate(){let t=this.saveExpandedStates();await this.persistExpandedStatesForCurrentFolder(t),await this.loadData(),this.restoreExpandedStates(t);let e=this.containerEl.children[1];if(!e)return;this.updateHeaderFolderName(e);let i=e.querySelector(".chinese-writer-tree-container");i&&(i.empty(),this.renderTree(i,this.treeData))}saveExpandedStates(){let t=new Map;return this.collectExpandedStates(this.treeData,t),t}collectExpandedStates(t,e,i=""){t.forEach(n=>{if(n.children.length===0)return;let r=this.getNodeKey(n,i);e.set(r,n.expanded),this.collectExpandedStates(n.children,e,r)})}getNodeKey(t,e=""){let i="";return t.type==="file"&&t.filePath?i=`file:${t.filePath}`:t.type==="h1"?i=`${e}>>h1:${t.text}`:t.type==="h2"?i=`${e}>>h2:${t.text}`:i=t.id,i}restoreExpandedStates(t){this.applyExpandedStates(this.treeData,t,"")}applyExpandedStates(t,e,i=""){t.forEach(n=>{let r=this.getNodeKey(n,i),s=e.get(r);s!==void 0&&(n.expanded=s),n.children.length>0&&this.applyExpandedStates(n.children,e,r)})}async loadData(){let t=this.getContextFile(),e=null;if(t&&(e=this.plugin.highlightManager.getSettingFolderForFile(t.path)),this.currentSettingFolder=e,!e){this.treeData=[];return}let i=this.plugin.parser,n=i.getMarkdownFilesInFolder(e),r=[];for(let c of n){let d=await i.parseFile(c);d&&r.push(d)}let s=this.plugin.orderManager.getFileOrder();s.length===0&&r.length>0&&(s=r.map(c=>c.filePath),await this.plugin.orderManager.setFileOrder(s)),s.length>0&&r.sort((c,d)=>{let p=s.indexOf(c.filePath),g=s.indexOf(d.filePath);return p===-1&&g===-1?0:p===-1?1:g===-1?-1:p-g}),this.treeData=[];let a=0;for(let c of r){let d=this.createFileNode(c,a++);this.treeData.push(d)}let o=this.plugin.orderManager.getExpandedStates(e),h=Object.entries(o);h.length>0&&this.restoreExpandedStates(new Map(h))}createFileNode(t,e){let i={id:`file-${e}`,text:t.fileName,type:"file",children:[],expanded:!1,filePath:t.filePath};return t.h1List.forEach((n,r)=>{let s={id:`${i.id}-h1-${r}`,text:n.text,type:"h1",children:[],expanded:!1};n.h2List.forEach((a,o)=>{let h=this.extractStatusFromLines(a.content),c={id:`${s.id}-h2-${o}`,text:a.text,type:"h2",children:[],expanded:!1,content:a.content,status:h};s.children.push(c)}),i.children.push(s)}),i}renderTree(t,e){if(e.length===0){t.createDiv({text:"\u672A\u627E\u5230\u6587\u4EF6\u6216\u76EE\u5F55\u4E3A\u7A7A",cls:"chinese-writer-empty"});return}let i=t.createEl("ul",{cls:"chinese-writer-tree"});e.forEach(n=>{this.renderNode(i,n)})}renderNode(t,e){let i=t.createEl("li",{cls:"tree-item"});i.setAttribute("data-node-id",e.id),i.setAttribute("data-node-type",e.type);let n=i.createDiv({cls:"tree-item-content"});if(n.setAttribute("draggable","true"),n.addEventListener("dragstart",o=>{o.stopPropagation(),this.onDragStart(o,e)}),n.addEventListener("dragover",o=>{o.stopPropagation(),this.onDragOver(o,e)}),n.addEventListener("dragleave",o=>{o.stopPropagation(),this.onDragLeave(o)}),n.addEventListener("drop",o=>{o.stopPropagation(),this.onDrop(o,e)}),n.addEventListener("dragend",o=>{o.stopPropagation(),this.onDragEnd(o)}),e.children.length>0){let o=n.createSpan({cls:"tree-item-toggle"});(0,b.setIcon)(o,e.expanded?"chevron-down":"chevron-right"),o.addEventListener("click",h=>{h.stopPropagation(),this.toggleNode(e,i)})}else n.createSpan({cls:"tree-item-toggle-placeholder"});let r=n.createSpan({cls:"tree-item-icon"}),s=e.type==="file"?"file-text":e.type==="h1"?"heading-1":"heading-2";(0,b.setIcon)(r,s),r.addEventListener("click",o=>{o.stopPropagation()});let a=n.createSpan({text:e.text,cls:`tree-item-text tree-item-${e.type}`});if(e.type==="h2"&&this.isDeadStatus(e.status)&&a.addClass("tree-item-h2-dead"),e.type==="file"||e.type==="h1"){let o=this.countH2(e);if(o>0){let h=n.createSpan({text:`[${o}]`,cls:"tree-item-count"})}}if(n.addEventListener("click",()=>{this.onNodeClick(e)}),n.addEventListener("contextmenu",o=>{o.preventDefault(),o.stopPropagation(),this.showContextMenu(o,e)}),e.children.length>0){let o=i.createEl("ul",{cls:"tree-item-children"});e.expanded||(o.style.display="none"),e.children.forEach(h=>{this.renderNode(o,h)})}}toggleNode(t,e){t.expanded=!t.expanded;let i=e.querySelector(".tree-item-toggle"),n=e.querySelector(".tree-item-children");i&&(i.empty(),(0,b.setIcon)(i,t.expanded?"chevron-down":"chevron-right")),n&&(n.style.display=t.expanded?"block":"none"),this.persistExpandedStatesForCurrentFolder()}toggleAllNodes(){this.allExpanded=!this.allExpanded,this.setAllNodesExpanded(this.treeData,this.allExpanded),this.updateAllNodesInDOM(this.allExpanded);let t=this.containerEl.children[1];if(!t)return;let e=t.querySelector(".chinese-writer-toggle-btn");e&&(e.empty(),(0,b.setIcon)(e,this.allExpanded?"list-chevrons-down-up":"list-chevrons-up-down")),this.persistExpandedStatesForCurrentFolder()}setAllNodesExpanded(t,e){t.forEach(i=>{i.expanded=e,i.children.length>0&&this.setAllNodesExpanded(i.children,e)})}updateAllNodesInDOM(t){let e=this.containerEl.children[1];if(!e)return;e.querySelectorAll(".tree-item").forEach(n=>{let r=n.getAttribute("data-node-id");if(!r)return;let s=this.findNodeById(this.treeData,r);if(!s||s.children.length===0)return;let a=n.querySelector(".tree-item-toggle");a&&(a.empty(),(0,b.setIcon)(a,t?"chevron-down":"chevron-right"));let o=n.querySelector(".tree-item-children");o&&(o.style.display=t?"block":"none")})}findNodeById(t,e){for(let i of t){if(i.id===e)return i;if(i.children.length>0){let n=this.findNodeById(i.children,e);if(n)return n}}return null}countH2(t){let e=0;return t.type==="file"?t.children.forEach(i=>{e+=i.children.length}):t.type==="h1"&&(e=t.children.length),e}onNodeClick(t){}getContextFile(){let t=this.app.workspace.getActiveFile();if(t)return t;if(this.lastObservedActiveFilePath){let e=this.app.vault.getAbstractFileByPath(this.lastObservedActiveFilePath);if(e instanceof b.TFile)return e}return null}extractStatusFromLines(t){let e="\u3010\u72B6\u6001\u3011";for(let i of t){let n=i.indexOf(e);if(n===-1)continue;let r=i.slice(n+e.length).trim();if(r)return r}return""}isDeadStatus(t){if(!t)return!1;let e=t.trim();return e==="\u6B7B\u4EA1"||e==="\u5931\u6548"}updateHeaderFolderName(t){let e=t.querySelector(".chinese-writer-folder-name");e&&e.setText(this.getFolderDisplayName(this.currentSettingFolder))}getFolderDisplayName(t){var i;if(!t)return"\u672A\u8BBE\u7F6E\u76EE\u5F55";let e=t.split(/[\\/]/).map(n=>n.trim()).filter(n=>n.length>0);return(i=e[e.length-1])!=null?i:"\u672A\u8BBE\u7F6E\u76EE\u5F55"}async persistExpandedStatesForCurrentFolder(t){if(!this.currentSettingFolder)return;let e=t!=null?t:this.saveExpandedStates(),i={};e.forEach((n,r)=>{i[r]=n}),await this.plugin.orderManager.setExpandedStates(this.currentSettingFolder,i)}onDragStart(t,e){this.draggedNode=e,t.dataTransfer.effectAllowed="move",t.dataTransfer.setData("text/plain",e.id),this.createDropIndicator()}onDragOver(t,e){if(t.preventDefault(),!this.draggedNode)return;if(e.type!==this.draggedNode.type){this.hideDropIndicator(),t.dataTransfer.dropEffect="none";return}if(e.id===this.draggedNode.id){this.hideDropIndicator(),t.dataTransfer.dropEffect="none";return}t.dataTransfer.dropEffect="move";let i=t.currentTarget,n=i.getBoundingClientRect(),r=n.top+n.height/2;this.insertBefore=t.clientY<r,this.showDropIndicator(i,this.insertBefore)}createDropIndicator(){this.dropIndicator||(this.dropIndicator=document.createElement("div"),this.dropIndicator.addClass("drop-indicator"),document.body.appendChild(this.dropIndicator))}showDropIndicator(t,e){if(!this.dropIndicator||!this.draggedNode)return;let i=t.getBoundingClientRect();this.dropIndicator.style.display="block",this.dropIndicator.style.left=`${i.left}px`,this.dropIndicator.style.width=`${i.width}px`,e?this.dropIndicator.style.top=`${i.top-1}px`:this.dropIndicator.style.top=`${i.bottom-1}px`}onDragLeave(t){let e=t.currentTarget,i=t.relatedTarget;e.contains(i)}hideDropIndicator(){this.dropIndicator&&(this.dropIndicator.style.display="none")}removeDropIndicator(){this.dropIndicator&&(this.dropIndicator.remove(),this.dropIndicator=null)}async onDrop(t,e){t.preventDefault(),t.stopPropagation(),this.hideDropIndicator(),!(!this.draggedNode||this.draggedNode.id===e.id)&&this.draggedNode.type===e.type&&await this.reorderNodes(this.draggedNode,e)}onDragEnd(t){t.currentTarget.removeClass("dragging"),this.removeDropIndicator(),this.draggedNode=null}async reorderNodes(t,e){t.type==="file"?await this.reorderFiles(t,e):t.type==="h1"?await this.reorderH1(t,e):t.type==="h2"&&await this.reorderH2(t,e)}async reorderFiles(t,e){if(!t.filePath||!e.filePath)return;let i=this.treeData.map(a=>a.filePath).filter(a=>a!==void 0),n=i.indexOf(t.filePath),r=i.indexOf(e.filePath);if(n===-1||r===-1)return;let[s]=i.splice(n,1);s&&(r=i.indexOf(e.filePath),this.insertBefore?i.splice(r,0,s):i.splice(r+1,0,s),await this.plugin.orderManager.setFileOrder(i),await this.smartUpdate())}async reorderH1(t,e){let i=this.findParentFileNode(t),n=this.findParentFileNode(e);if(!i||!n)return;if(i.id===n.id){if(!i.filePath)return;let s=i.children.map(c=>c.text),a=s.indexOf(t.text),o=s.indexOf(e.text);if(a===-1||o===-1)return;let[h]=s.splice(a,1);if(!h)return;o=s.indexOf(e.text),this.insertBefore?s.splice(o,0,h):s.splice(o+1,0,h),await this.plugin.orderManager.reorderH1InFile(i.filePath,s)}else{if(!i.filePath||!n.filePath)return;await this.plugin.orderManager.moveH1BetweenFiles(i.filePath,n.filePath,t.text,e.text,this.insertBefore)}await this.smartUpdate()}async reorderH2(t,e){let i=this.findParentH1Node(t),n=this.findParentH1Node(e),r=this.findParentFileNode(t),s=this.findParentFileNode(e);if(!i||!n||!r||!s)return;if(i.id===n.id){if(!r.filePath)return;let o=i.children.map(p=>p.text),h=o.indexOf(t.text),c=o.indexOf(e.text);if(h===-1||c===-1)return;let[d]=o.splice(h,1);if(!d)return;c=o.indexOf(e.text),this.insertBefore?o.splice(c,0,d):o.splice(c+1,0,d),await this.plugin.orderManager.reorderH2InFile(r.filePath,i.text,o)}else{if(!r.filePath||!s.filePath)return;await this.plugin.orderManager.moveH2BetweenH1s(r.filePath,i.text,s.filePath,n.text,t.text,e.text,this.insertBefore)}await this.smartUpdate()}findParentFileNode(t){let e=t.id.match(/^file-(\d+)/);if(!e||!e[1])return null;let i=parseInt(e[1]);return this.treeData[i]||null}findParentH1Node(t){let e=t.id.match(/^file-(\d+)-h1-(\d+)/);if(!e||!e[1]||!e[2])return null;let i=parseInt(e[1]),n=parseInt(e[2]),r=this.treeData[i];return r&&r.children[n]||null}showContextMenu(t,e){let i=new b.Menu;e.type==="file"?this.addH1ContextMenu(i,e):e.type==="h1"?this.addH2ContextMenu(i,e):e.type==="h2"&&this.addH2SelfContextMenu(i,e),i.showAtMouseEvent(t)}showEmptyAreaContextMenu(t){let e=new b.Menu;this.addFileContextMenuForEmpty(e),e.showAtMouseEvent(t)}addFileContextMenuForEmpty(t){t.addItem(e=>{e.setTitle("\u521B\u5EFA\u96C6\u5408").setIcon("file-text").onClick(async()=>{await this.createFile()})})}addH1ContextMenu(t,e){t.addItem(i=>{i.setTitle("\u521B\u5EFA\u96C6\u5408").setIcon("file-text").onClick(async()=>{await this.createFile()})}),t.addItem(i=>{i.setTitle("\u521B\u5EFA\u5206\u7C7B").setIcon("heading-1").onClick(async()=>{await this.createH1(e)})}),t.addSeparator(),t.addItem(i=>{i.setTitle("\u91CD\u547D\u540D\u96C6\u5408").setIcon("pencil").onClick(async()=>{await this.renameFile(e)})}),t.addItem(i=>{i.setTitle("\u5220\u9664\u96C6\u5408").setIcon("trash").setWarning(!0).onClick(async()=>{await this.deleteFile(e)})})}addH2ContextMenu(t,e){let i=this.findParentFileNode(e);i&&t.addItem(n=>{n.setTitle("\u521B\u5EFA\u5206\u7C7B").setIcon("heading-1").onClick(async()=>{await this.createH1(i)})}),t.addItem(n=>{n.setTitle("\u521B\u5EFA\u8BBE\u5B9A").setIcon("heading-2").onClick(async()=>{await this.createH2(e)})}),t.addSeparator(),t.addItem(n=>{n.setTitle("\u91CD\u547D\u540D\u5206\u7C7B").setIcon("pencil").onClick(async()=>{await this.renameH1(e)})}),t.addItem(n=>{n.setTitle("\u5220\u9664\u5206\u7C7B").setIcon("trash").setWarning(!0).onClick(async()=>{await this.deleteH1(e)})})}addH2SelfContextMenu(t,e){let i=this.findParentH1Node(e);i&&t.addItem(n=>{n.setTitle("\u521B\u5EFA\u8BBE\u5B9A").setIcon("heading-2").onClick(async()=>{await this.createH2(i)})}),t.addItem(n=>{n.setTitle("\u7F16\u8F91\u8BBE\u5B9A").setIcon("heading-2").onClick(async()=>{await this.editH2(e)})}),t.addSeparator(),t.addItem(n=>{n.setTitle("\u91CD\u547D\u540D\u8BBE\u5B9A").setIcon("pencil").onClick(async()=>{await this.renameH2(e)})}),t.addItem(n=>{n.setTitle("\u5220\u9664\u8BBE\u5B9A").setIcon("trash").setWarning(!0).onClick(async()=>{await this.deleteH2(e)})})}async createFile(){new E(this.app,"\u521B\u5EFA\u96C6\u5408","\u8BF7\u8F93\u5165\u96C6\u5408\u540D\u79F0","",async e=>{if(!e.trim())return;let i=this.app.workspace.getActiveFile(),n=null;if(i&&(n=this.plugin.highlightManager.getSettingFolderForFile(i.path)),!n)return;let r=e.trim(),s=`${n}/${r}.md`;if(this.app.vault.getAbstractFileByPath(s))return;let o=await this.app.vault.create(s,"");await this.plugin.openFileWithSettings(o);let h=this.plugin.orderManager.getFileOrder();h.length===0?h=this.plugin.parser.getMarkdownFilesInFolder(n).map(p=>p.path):h.push(s),await this.plugin.orderManager.setFileOrder(h),await new Promise(c=>setTimeout(c,400)),await this.smartUpdate()}).open()}async renameFile(t){if(!t.filePath)return;let e=this.app.vault.getAbstractFileByPath(t.filePath);if(!(e instanceof b.TFile))return;new E(this.app,"\u91CD\u547D\u540D\u96C6\u5408","\u8BF7\u8F93\u5165\u65B0\u540D\u79F0",t.text,async n=>{if(!n.trim()||n.trim()===t.text)return;let r=n.trim(),a=`${t.filePath.substring(0,t.filePath.lastIndexOf("/"))}/${r}.md`;await this.app.fileManager.renameFile(e,a);let o=this.plugin.orderManager.getFileOrder(),h=o.indexOf(t.filePath);h!==-1&&(o[h]=a,await this.plugin.orderManager.setFileOrder(o)),await this.smartUpdate()}).open()}async deleteFile(t){if(!t.filePath)return;let e=this.app.vault.getAbstractFileByPath(t.filePath);if(!(e instanceof b.TFile))return;new k(this.app,"\u5220\u9664\u96C6\u5408",`\u786E\u5B9A\u8981\u5220\u9664\u96C6\u5408"${t.text}"\u5417\uFF1F\u6B64\u64CD\u4F5C\u4E0D\u53EF\u6062\u590D\u3002`,async()=>{let n=this.plugin.orderManager.getFileOrder();if(n.length===0){let s=this.app.workspace.getActiveFile(),a=null;s&&(a=this.plugin.highlightManager.getSettingFolderForFile(s.path)),a&&(n=this.plugin.parser.getMarkdownFilesInFolder(a).map(c=>c.path))}await this.app.vault.delete(e);let r=n.indexOf(t.filePath);r!==-1&&(n.splice(r,1),await this.plugin.orderManager.setFileOrder(n)),await new Promise(s=>setTimeout(s,400)),await this.smartUpdate()}).open()}async createH1(t){let e=this.findParentFileNode(t);if(!e||!e.filePath)return;new E(this.app,"\u521B\u5EFA\u5206\u7C7B","\u8BF7\u8F93\u5165\u5206\u7C7B\u540D\u79F0","",async n=>{if(!n.trim())return;let r=n.trim(),s=this.app.vault.getAbstractFileByPath(e.filePath);if(!(s instanceof b.TFile))return;let o=(await this.app.vault.read(s)).split(`
`);o.push(`# ${r}`),await this.app.vault.modify(s,o.join(`
`)),await this.smartUpdate()}).open()}async renameH1(t){let e=this.findParentFileNode(t);if(!e||!e.filePath)return;new E(this.app,"\u91CD\u547D\u540D\u5206\u7C7B","\u8BF7\u8F93\u5165\u65B0\u540D\u79F0",t.text,async n=>{if(!n.trim()||n.trim()===t.text)return;let r=n.trim(),s=this.app.vault.getAbstractFileByPath(e.filePath);if(!(s instanceof b.TFile))return;let o=(await this.app.vault.read(s)).split(`
`);for(let h=0;h<o.length;h++){let c=o[h];if(!c)continue;let d=c.trim();if(d.startsWith("# ")&&!d.startsWith("## ")&&d.substring(2).trim()===t.text){o[h]=`# ${r}`;break}}await this.app.vault.modify(s,o.join(`
`)),await this.smartUpdate()}).open()}async deleteH1(t){let e=this.findParentFileNode(t);if(!e||!e.filePath)return;new k(this.app,"\u5220\u9664\u5206\u7C7B",`\u786E\u5B9A\u8981\u5220\u9664\u5206\u7C7B"${t.text}"\u53CA\u5176\u4E0B\u7684\u6240\u6709\u5185\u5BB9\u5417\uFF1F\u6B64\u64CD\u4F5C\u4E0D\u53EF\u6062\u590D\u3002`,async()=>{let n=this.app.vault.getAbstractFileByPath(e.filePath);if(!(n instanceof b.TFile))return;let s=(await this.app.vault.read(n)).split(`
`),a=-1,o=s.length,h=!1;for(let d=0;d<s.length;d++){let p=s[d];if(!p)continue;let g=p.trim();if(g.startsWith("# ")&&!g.startsWith("## ")){if(g.substring(2).trim()===t.text)a=d,h=!0;else if(h){o=d;break}}}if(a===-1)return;let c=[...s.slice(0,a),...s.slice(o)];await this.app.vault.modify(n,c.join(`
`)),await this.smartUpdate(),this.plugin.highlightManager&&this.plugin.highlightManager.refreshCurrentEditor()}).open()}async createH2(t){let e=this.findParentH1Node(t),i=this.findParentFileNode(t);if(!e||!i||!i.filePath)return;new E(this.app,"\u521B\u5EFA\u8BBE\u5B9A","\u8BF7\u8F93\u5165\u8BBE\u5B9A\u540D\u79F0","",async r=>{if(!r.trim())return;let s=r.trim(),a=this.app.vault.getAbstractFileByPath(i.filePath);if(!(a instanceof b.TFile))return;let h=(await this.app.vault.read(a)).split(`
`),c=h.length,d=!1;for(let g=0;g<h.length;g++){let u=h[g];if(!u)continue;let v=u.trim();if(v.startsWith("# ")&&!v.startsWith("## ")){if(v.substring(2).trim()===e.text)d=!0;else if(d){c=g;break}}}let p=[...h.slice(0,c),`## ${s}`,...h.slice(c)];await this.app.vault.modify(a,p.join(`
`)),await this.smartUpdate(),this.plugin.highlightManager&&this.plugin.highlightManager.refreshCurrentEditor()}).open()}async renameH2(t){let e=this.findParentH1Node(t),i=this.findParentFileNode(t);if(!e||!i||!i.filePath)return;new E(this.app,"\u91CD\u547D\u540D\u8BBE\u5B9A","\u8BF7\u8F93\u5165\u65B0\u540D\u79F0",t.text,async r=>{if(!r.trim()||r.trim()===t.text)return;let s=r.trim(),a=this.app.vault.getAbstractFileByPath(i.filePath);if(!(a instanceof b.TFile))return;let h=(await this.app.vault.read(a)).split(`
`),c=!1;for(let d=0;d<h.length;d++){let p=h[d];if(!p)continue;let g=p.trim();if(g.startsWith("# ")&&!g.startsWith("## "))c=g.substring(2).trim()===e.text;else if(c&&g.startsWith("## ")&&!g.startsWith("### ")&&g.substring(3).trim()===t.text){h[d]=`## ${s}`;break}}await this.app.vault.modify(a,h.join(`
`)),await this.smartUpdate(),this.plugin.highlightManager&&this.plugin.highlightManager.refreshCurrentEditor()}).open()}async deleteH2(t){let e=this.findParentH1Node(t),i=this.findParentFileNode(t);if(!e||!i||!i.filePath)return;new k(this.app,"\u5220\u9664\u8BBE\u5B9A",`\u786E\u5B9A\u8981\u5220\u9664\u8BBE\u5B9A"${t.text}"\u53CA\u5176\u5185\u5BB9\u5417\uFF1F\u6B64\u64CD\u4F5C\u4E0D\u53EF\u6062\u590D\u3002`,async()=>{let r=this.app.vault.getAbstractFileByPath(i.filePath);if(!(r instanceof b.TFile))return;let a=(await this.app.vault.read(r)).split(`
`),o=-1,h=a.length,c=!1,d=!1;for(let g=0;g<a.length;g++){let u=a[g];if(!u)continue;let v=u.trim();if(v.startsWith("# ")&&!v.startsWith("## ")){if(c=v.substring(2).trim()===e.text,c===!1&&d){h=g;break}}else if(c&&v.startsWith("## ")&&!v.startsWith("### ")){if(v.substring(3).trim()===t.text)o=g,d=!0;else if(d){h=g;break}}}if(o===-1)return;let p=[...a.slice(0,o),...a.slice(h)];await this.app.vault.modify(r,p.join(`
`)),await this.smartUpdate(),this.plugin.highlightManager&&this.plugin.highlightManager.refreshCurrentEditor()}).open()}async editH2(t){let e=this.findParentH1Node(t),i=this.findParentFileNode(t);if(!e||!i||!i.filePath)return;let n=this.app.vault.getAbstractFileByPath(i.filePath);if(!(n instanceof b.TFile))return;let s=(await this.app.vault.read(n)).split(`
`),a=this.findFirstContentLine(s,e.text,t.text),o=await this.plugin.openFileWithSettings(n,{revealWhenNewTab:!0});if(!o)return;let h=o.view instanceof b.MarkdownView?o.view:null;h!=null&&h.editor&&h.editor.setCursor({line:a,ch:0})}findFirstContentLine(t,e,i){var a,o;let n=!1,r=!1,s=0;for(let h=0;h<t.length;h++){let c=(o=(a=t[h])==null?void 0:a.trim())!=null?o:"";if(c.startsWith("# ")&&!c.startsWith("## ")){n=c.slice(2).trim()===e,r=!1;continue}if(n&&c.startsWith("## ")&&!c.startsWith("### ")){r=c.slice(3).trim()===i,r&&(s=h);continue}if(r){if(c.startsWith("#"))break;if(c.length>0)return h}}return s}};var H=require("obsidian"),B=class{constructor(l,t){this.saveTimeout=null;this.isSaving=!1;this.app=l,this.viewDataFilePath=`${t}/cw-view-datas.json`,this.legacyViewDataFilePath=`${t}/view-datas.json`,this.legacyOrderFilePath=`${t}/order.json`,this.orderData={files:[],expandedStatesByFolder:{}}}async load(){try{let l=this.app.vault.adapter,t=await l.exists(this.viewDataFilePath),e=await l.exists(this.legacyViewDataFilePath),i=await l.exists(this.legacyOrderFilePath),n=this.viewDataFilePath;if(!t&&e?n=this.legacyViewDataFilePath:!t&&i&&(n=this.legacyOrderFilePath),!await l.exists(n)){this.orderData={files:[],expandedStatesByFolder:{}};return}let s=await l.read(n),a=JSON.parse(s),o=Array.isArray(a==null?void 0:a.files)?a.files.filter(c=>typeof c=="string"&&c.length>0):[],h={};if(a!=null&&a.expandedStatesByFolder&&typeof a.expandedStatesByFolder=="object")for(let[c,d]of Object.entries(a.expandedStatesByFolder)){if(!d||typeof d!="object")continue;let p={};for(let[g,u]of Object.entries(d))typeof u=="boolean"&&(g.includes(">>h2:")||(p[g]=u));h[c]=p}this.orderData={files:o,expandedStatesByFolder:h},n===this.legacyOrderFilePath&&!t&&await this.saveNow(),n===this.legacyViewDataFilePath&&!t&&await this.saveNow()}catch(l){this.orderData={files:[],expandedStatesByFolder:{}}}}async save(){return this.saveTimeout&&clearTimeout(this.saveTimeout),new Promise(l=>{this.saveTimeout=setTimeout(async()=>{await this.saveNow(),l()},300)})}async saveNow(){if(this.isSaving)return await new Promise(l=>setTimeout(l,100)),this.saveNow();this.isSaving=!0;try{let l=JSON.stringify(this.orderData,null,2),t=this.app.vault.adapter;if(await t.exists(this.viewDataFilePath))await t.write(this.viewDataFilePath,l);else{let i=this.viewDataFilePath.substring(0,this.viewDataFilePath.lastIndexOf("/"));i&&!await t.exists(i)&&await t.mkdir(i),await t.write(this.viewDataFilePath,l)}}catch(l){console.error("Failed to save order data:",l)}finally{this.isSaving=!1}}getFileOrder(){return this.orderData.files}async setFileOrder(l){this.orderData.files=l,await this.save()}getExpandedStates(l){var t;return(t=this.orderData.expandedStatesByFolder[l])!=null?t:{}}async setExpandedStates(l,t){this.orderData.expandedStatesByFolder[l]=t,await this.save()}async removeFolderData(l){this.orderData.expandedStatesByFolder[l]&&delete this.orderData.expandedStatesByFolder[l],await this.save()}async reorderH1InFile(l,t){let e=this.app.vault.getAbstractFileByPath(l);if(!(e instanceof H.TFile))return;let n=(await this.app.vault.read(e)).split(`
`),r=new Map,s=null,a=[],o=[],h=!0;for(let p of n){let g=p.trim();g.startsWith("# ")&&!g.startsWith("## ")?(s?r.set(s,a):h&&(o=a,h=!1),s=g.substring(2).trim(),a=[p]):a.push(p)}s&&r.set(s,a);let c=[...o];for(let p of t){let g=r.get(p);g&&c.push(...g)}let d=c.join(`
`);await this.app.vault.modify(e,d)}async reorderH2InFile(l,t,e){let i=this.app.vault.getAbstractFileByPath(l);if(!(i instanceof H.TFile))return;let r=(await this.app.vault.read(i)).split(`
`),s=-1,a=r.length,o=!1;for(let f=0;f<r.length;f++){let w=r[f];if(!w)continue;let y=w.trim();if(y.startsWith("# ")&&!y.startsWith("## ")){if(y.substring(2).trim()===t)s=f,o=!0;else if(o){a=f;break}}}if(s===-1)return;let h=new Map,c=null,d=[],p=[],g=!0;for(let f=s;f<a;f++){let w=r[f];if(w===void 0)continue;let y=w.trim();if(f===s){p.push(w);continue}y.startsWith("## ")&&!y.startsWith("### ")?(c?h.set(c,d):g&&(p.push(...d),g=!1),c=y.substring(3).trim(),d=[w]):d.push(w)}c?h.set(c,d):d.length>0&&p.push(...d);let u=[...p];for(let f of e){let w=h.get(f);w&&u.push(...w)}let m=[...r.slice(0,s),...u,...r.slice(a)].join(`
`);await this.app.vault.modify(i,m)}async moveH1BetweenFiles(l,t,e,i,n=!1){let r=this.app.vault.getAbstractFileByPath(l);if(!(r instanceof H.TFile))return;let a=(await this.app.vault.read(r)).split(`
`),o=[],h=!1,c=!1;for(let f of a){let w=f.trim();if(w.startsWith("# ")&&!w.startsWith("## ")){if(w.substring(2).trim()===e)c=!0,h=!0,o.push(f);else if(c)break}else c&&o.push(f)}if(!h)return;let d=a.filter((f,w)=>{let y=f.trim();if(y.startsWith("# ")&&!y.startsWith("## ")&&y.substring(2).trim()===e)return!1;let M=f;return!o.includes(M)});await this.app.vault.modify(r,d.join(`
`));let p=this.app.vault.getAbstractFileByPath(t);if(!(p instanceof H.TFile))return;let u=(await this.app.vault.read(p)).split(`
`),v=u.length;for(let f=0;f<u.length;f++){let w=u[f];if(!w)continue;let y=w.trim();if(y.startsWith("# ")&&!y.startsWith("## ")&&y.substring(2).trim()===i){if(n)v=f;else for(let L=f+1;L<u.length;L++){let U=u[L];if(!U)continue;let q=U.trim();if(q.startsWith("# ")&&!q.startsWith("## ")){v=L;break}}break}}let m=[...u.slice(0,v),...o,...u.slice(v)];await this.app.vault.modify(p,m.join(`
`))}async moveH2BetweenH1s(l,t,e,i,n,r,s=!1){let a=this.app.vault.getAbstractFileByPath(l);if(!(a instanceof H.TFile))return;let h=(await this.app.vault.read(a)).split(`
`),c=[],d=!1,p=!1;for(let g of h){let u=g.trim();if(u.startsWith("# ")&&!u.startsWith("## ")){if(d=u.substring(2).trim()===t,!d&&p)break}else if(d&&u.startsWith("## ")&&!u.startsWith("### ")){if(u.substring(3).trim()===n)p=!0,c.push(g);else if(p)break}else p&&c.push(g)}c.length!==0&&(await this.removeH2FromFile(l,t,n),await this.insertH2ToFile(e,i,r,c,s))}async removeH2FromFile(l,t,e){let i=this.app.vault.getAbstractFileByPath(l);if(!(i instanceof H.TFile))return;let r=(await this.app.vault.read(i)).split(`
`),s=[],a=!1,o=!1;for(let h of r){let c=h.trim();c.startsWith("# ")&&!c.startsWith("## ")?(a=c.substring(2).trim()===t,o=!1,s.push(h)):a&&c.startsWith("## ")&&!c.startsWith("### ")?c.substring(3).trim()===e?o=!0:(o=!1,s.push(h)):o||s.push(h)}await this.app.vault.modify(i,s.join(`
`))}async insertH2ToFile(l,t,e,i,n=!1){let r=this.app.vault.getAbstractFileByPath(l);if(!(r instanceof H.TFile))return;let a=(await this.app.vault.read(r)).split(`
`),o=a.length,h=!1,c=!1;for(let p=0;p<a.length;p++){let g=a[p];if(!g)continue;let u=g.trim();if(u.startsWith("# ")&&!u.startsWith("## ")){if(u.substring(2).trim()===t)h=!0;else if(h){o=p;break}}else if(h&&u.startsWith("## ")&&!u.startsWith("### ")&&u.substring(3).trim()===e)if(c=!0,n){o=p;break}else{for(let m=p+1;m<a.length;m++){let f=a[m];if(!f)continue;let w=f.trim();if(w.startsWith("## ")&&!w.startsWith("### ")){o=m;break}else if(w.startsWith("# ")&&!w.startsWith("## ")){o=m;break}}break}}let d=[...a.slice(0,o),...i,...a.slice(o)];await this.app.vault.modify(r,d.join(`
`))}};var T=require("obsidian"),P=require("@codemirror/view"),I=require("@codemirror/state"),V=class{constructor(l){this.keywordsCache=new Map;this.keywordPreviewCache=new Map;this.keywordGroupCache=new Map;this.keywordsVersion=0;this.previewEl=null;this.previewHoverKey="";this.previewAnchorEl=null;this.currentPreviewData=null;this.previewHideTimer=null;this.previewHideDelayMs=450;this.plugin=l,this.app=l.app,this.initializeHoverPreview(),this.plugin.register(()=>this.destroyHoverPreview())}getSettingFolderForFile(l){for(let t of this.plugin.settings.folderMappings)if(t.novelFolder&&t.settingFolder){let e=t.novelFolder.replace(/^\/+|\/+$/g,"");if(l.replace(/^\/+/,"").startsWith(e+"/"))return t.settingFolder}return null}async extractKeywordsFromSettingFolder(l){if(this.keywordsCache.has(l)&&this.keywordPreviewCache.has(l)&&this.keywordGroupCache.has(l))return this.keywordsCache.get(l);let t=new Set,e=new Map,i=new Map;if(!l)return t;let n=this.plugin.parser.getMarkdownFilesInFolder(l);for(let r of n){let s=await this.plugin.parser.parseFile(r);if(s)for(let a of s.h1List)for(let o of a.h2List){let h=o.text.trim();if(h){let c=this.extractAliases(o.content),d=`h2::${s.filePath}::${a.text}::${o.text}`,p={keyword:h,filePath:s.filePath,fileName:s.fileName,h1Title:a.text,h2Title:o.text,status:this.extractPreferredStatus(o.content),aliases:c,bodyLines:this.extractBodyLines(o.content)};this.addKeywordVariant(t,e,i,h,p,d);for(let u of c)this.addKeywordVariant(t,e,i,u,p,d);let g=this.extractH3Sections(o.content);for(let u of g){if(!u.title)continue;let v=`h3::${s.filePath}::${a.text}::${o.text}::${u.title}`,m={keyword:u.title,filePath:s.filePath,fileName:s.fileName,h1Title:a.text,h2Title:o.text,status:u.status,aliases:u.aliases,bodyLines:u.bodyLines};this.addKeywordVariant(t,e,i,u.title,m,v);for(let f of u.aliases)this.addKeywordVariant(t,e,i,f,m,v)}}}}return this.keywordsCache.set(l,t),this.keywordPreviewCache.set(l,e),this.keywordGroupCache.set(l,i),t}clearCache(){this.keywordsCache.clear(),this.keywordPreviewCache.clear(),this.keywordGroupCache.clear(),this.keywordsVersion++}getKeywordsVersion(){return this.keywordsVersion}refreshCurrentEditor(){this.clearCache();let l=this.app.workspace.getLeavesOfType("markdown");for(let t of l){let e=t.view;if(e instanceof T.MarkdownView&&e.editor){e.editor.refresh();let i=e.editor.cm;i&&i.dispatch({annotations:I.Transaction.addToHistory.of(!1)})}}}getMarkdownViewForEditorView(l){let t=this.app.workspace.getLeavesOfType("markdown");for(let e of t){let i=e.view;if(!(i instanceof T.MarkdownView))continue;if(i.editor.cm===l)return i}return null}extractAliases(l){let t=[];for(let e of l){let i="\u3010\u522B\u540D\u3011",n=e.indexOf(i);if(n===-1)continue;let r=e.slice(n+i.length).trim();if(!r)continue;let s=r.split(/[，,]/);for(let a of s){let o=a.trim();o&&t.push(o)}}return[...new Set(t)]}extractBodyLines(l){return l.map(t=>t.trim()).filter(t=>t.length>0).filter(t=>!/【[^】]+】/.test(t)).map(t=>t.replace(/^[-*+]\s+/,"").trim()).filter(t=>t.length>0)}extractPreferredStatus(l){let t=[];for(let e of l){let i="\u3010\u72B6\u6001\u3011",n=e.indexOf(i);if(n===-1)continue;let r=e.slice(n+i.length).trim();if(!r)continue;let s=r.replace(/\s+/g," ").trim();s.includes("\u6B7B\u4EA1")&&t.push("\u6B7B\u4EA1"),s.includes("\u5931\u6548")&&t.push("\u5931\u6548");let a=s.split(/[，,、/|；;]+/);for(let o of a){let h=o.trim();h&&t.push(h)}}if(t.length!==0)return t.includes("\u6B7B\u4EA1")?"\u6B7B\u4EA1":t.includes("\u5931\u6548")?"\u5931\u6548":t[0]}getKeywordPreview(l,t){var i;let e=this.keywordPreviewCache.get(l);return e&&(i=e.get(t))!=null?i:null}getKeywordGroupMap(l){var t;return(t=this.keywordGroupCache.get(l))!=null?t:new Map}addKeywordVariant(l,t,e,i,n,r){let s=i.trim();s&&(t.has(s)||(l.add(s),t.set(s,n),e.set(s,r)))}extractH3Sections(l){let t=[],e="",i=[],n=()=>{e&&t.push({title:e,status:this.extractPreferredStatus(i),aliases:this.extractAliases(i),bodyLines:this.extractBodyLines(i)})};for(let r of l){let s=r.trim();if(s.startsWith("### ")&&!s.startsWith("#### ")){n(),e=s.slice(4).trim(),i=[];continue}e&&i.push(r)}return n(),t}initializeHoverPreview(){this.previewEl=document.createElement("div"),this.previewEl.className="chinese-writer-highlight-preview",this.previewEl.style.display="none",document.body.appendChild(this.previewEl),this.plugin.registerDomEvent(this.previewEl,"mouseenter",()=>{this.clearScheduledHidePreview()}),this.plugin.registerDomEvent(this.previewEl,"mouseleave",()=>{this.scheduleHidePreview()}),this.plugin.registerDomEvent(document,"mousemove",l=>{this.handlePreviewHover(l)}),this.plugin.registerDomEvent(document,"mousedown",l=>{var n,r;let t=l.target;if(!t){this.hidePreview();return}let e=(r=(n=this.previewEl)==null?void 0:n.contains(t))!=null?r:!1,i=!!t.closest(".chinese-writer-highlight");!e&&!i&&this.hidePreview()}),this.plugin.registerDomEvent(document,"mouseleave",()=>this.scheduleHidePreview(120))}destroyHoverPreview(){this.clearScheduledHidePreview(),this.previewEl&&(this.previewEl.remove(),this.previewEl=null)}handlePreviewHover(l){var o,h;let t=l.target;if(!t){this.scheduleHidePreview();return}if((h=(o=this.previewEl)==null?void 0:o.contains(t))!=null?h:!1){this.clearScheduledHidePreview();return}let i=t.closest(".chinese-writer-highlight");if(!i){this.scheduleHidePreview();return}let n=i.dataset.cwKeyword,r=i.dataset.cwSettingFolder;if(!n||!r){this.scheduleHidePreview();return}let s=this.getKeywordPreview(r,n);if(!s){this.scheduleHidePreview();return}this.clearScheduledHidePreview();let a=`${r}::${n}`;this.showPreview(s,a,i,l.clientX,l.clientY)}showPreview(l,t,e,i,n){if(!this.previewEl)return;let r=this.previewHoverKey!==t,s=this.previewAnchorEl!==e;if(r){this.previewEl.empty();let o=this.previewEl.createDiv({cls:"cw-preview-header"}),h=o.createDiv({cls:"cw-preview-header-main"}),c=h.createDiv({cls:"cw-preview-title"}),d=l.status?`${l.keyword}[${l.status}]`:l.keyword;c.setText(d),h.createDiv({cls:"cw-preview-location"}).setText(`${l.fileName}/${l.h1Title}`);let g=o.createDiv({cls:"cw-preview-actions"}),u=g.createEl("button",{cls:"cw-preview-btn",attr:{"aria-label":"\u641C\u7D22",title:"\u641C\u7D22"}});(0,T.setIcon)(u,"search"),u.addEventListener("click",async f=>{f.preventDefault(),f.stopPropagation(),await this.openGlobalSearch(l.keyword)});let v=g.createEl("button",{cls:"cw-preview-btn",attr:{"aria-label":"\u7F16\u8F91",title:"\u7F16\u8F91"}});(0,T.setIcon)(v,"pen"),v.addEventListener("click",async f=>{f.preventDefault(),f.stopPropagation(),await this.openKeywordSource(l)}),l.aliases.length>0&&(this.previewEl.createDiv({cls:"cw-preview-blank-line"}).setText(" "),this.previewEl.createDiv({cls:"cw-preview-label"}).setText("\u522B\u540D"),this.previewEl.createDiv({cls:"cw-preview-aliases"}).setText(l.aliases.join(" "))),this.previewEl.createDiv({cls:"cw-preview-divider"});let m=this.previewEl.createDiv({cls:"cw-preview-body"});if(l.bodyLines.length===0)m.createDiv({cls:"cw-preview-empty",text:"\uFF08\u65E0\u8BBE\u5B9A\u5185\u5BB9\uFF09"});else{let f=m.createEl("ul",{cls:"cw-preview-list"});for(let w of l.bodyLines)f.createEl("li",{cls:"cw-preview-line"}).setText(w)}this.previewHoverKey=t,this.previewAnchorEl=e,this.currentPreviewData=l}let a=this.plugin.settings.highlightPreviewStyle;if(this.previewEl.style.width=`${a.width}px`,this.previewEl.style.maxHeight=`${a.height}px`,this.previewEl.style.setProperty("--cw-preview-max-lines",String(a.maxBodyLines)),this.previewEl.style.display="flex",this.applyBodyMaxHeight(a.height,a.maxBodyLines),r||s){this.previewAnchorEl=e;let o=14,h=i+o,c=n+o,d=this.previewEl.getBoundingClientRect();h+d.width>window.innerWidth-8&&(h=Math.max(8,i-d.width-o)),c+d.height>window.innerHeight-8&&(c=Math.max(8,n-d.height-o)),this.previewEl.style.left=`${h}px`,this.previewEl.style.top=`${c}px`}}hidePreview(){this.clearScheduledHidePreview(),this.previewEl&&(this.previewEl.style.display="none",this.previewHoverKey="",this.previewAnchorEl=null,this.currentPreviewData=null)}scheduleHidePreview(l=this.previewHideDelayMs){this.clearScheduledHidePreview(),this.previewHideTimer=window.setTimeout(()=>{this.hidePreview()},l)}clearScheduledHidePreview(){this.previewHideTimer!==null&&(window.clearTimeout(this.previewHideTimer),this.previewHideTimer=null)}applyBodyMaxHeight(l,t){if(!this.previewEl)return;let e=this.previewEl.querySelector(".cw-preview-body");if(!e)return;let n=Math.max(40,t*21),r=Math.max(0,this.previewEl.offsetHeight-e.offsetHeight),s=Math.max(40,l-r-4),a=Math.min(n,s);e.style.maxHeight=`${a}px`}async openGlobalSearch(l){let t=l.trim();if(!t)return;let e=this.app.commands;e&&await e.executeCommandById("global-search:open"),window.setTimeout(()=>{var a;let i=this.app.workspace.getLeavesOfType("search");if(i.length===0)return;let n=(a=i[0])==null?void 0:a.view,r=n==null?void 0:n.containerEl;if(!r)return;let s=r.querySelector("input");s&&(s.value=t,s.dispatchEvent(new Event("input",{bubbles:!0})),s.dispatchEvent(new KeyboardEvent("keydown",{key:"Enter",bubbles:!0})),s.focus())},80)}async openKeywordSource(l){let t=this.app.vault.getAbstractFileByPath(l.filePath);if(!(t instanceof T.TFile))return;let i=(await this.app.vault.read(t)).split(`
`),n=this.findFirstContentLine(i,l.h1Title,l.h2Title),r=await this.plugin.openFileWithSettings(t,{revealWhenNewTab:!0});if(!r)return;let s=r.view instanceof T.MarkdownView?r.view:null;s!=null&&s.editor&&(s.editor.setCursor({line:n,ch:0}),this.hidePreview())}findFirstContentLine(l,t,e){var s,a;let i=!1,n=!1,r=0;for(let o=0;o<l.length;o++){let h=(a=(s=l[o])==null?void 0:s.trim())!=null?a:"";if(h.startsWith("# ")&&!h.startsWith("## ")){i=h.slice(2).trim()===t,n=!1;continue}if(i&&h.startsWith("## ")&&!h.startsWith("### ")){n=h.slice(3).trim()===e,n&&(r=o);continue}if(n){if(h.startsWith("#"))break;if(h.length>0)return o}}return r}isFileInFolder(l,t){let e=t.replace(/^\/+|\/+$/g,""),i=l.replace(/^\/+/,"");return e?i.startsWith(e+"/"):!1}collectPunctuationWarnings(l){let t=this.plugin.settings.punctuationCheck;if(!(t!=null&&t.enabled))return[];let e=new Set;for(let i=0;i<l.length;i++){let n=l[i];t.comma&&n===","&&e.add(i),t.period&&n==="."&&e.add(i),t.colon&&n===":"&&e.add(i),t.semicolon&&n===";"&&e.add(i),t.exclamation&&n==="!"&&e.add(i),t.question&&n==="?"&&e.add(i),t.doubleQuote&&n==='"'&&e.add(i),t.singleQuote&&n==="'"&&e.add(i)}if(t.doubleQuote){let i=[];for(let n=0;n<l.length;n++){let r=l[n];r==="\u201C"?i.push(n):r==="\u201D"&&(i.length>0?i.pop():e.add(n))}for(let n of i)e.add(n)}if(t.singleQuote){let i=[];for(let n=0;n<l.length;n++){let r=l[n];r==="\u2018"?i.push(n):r==="\u2019"&&(i.length>0?i.pop():e.add(n))}for(let n of i)e.add(n)}return Array.from(e).sort((i,n)=>i-n)}createEditorExtension(){let l=this;return P.ViewPlugin.fromClass(class{constructor(t){this.decorations=P.Decoration.none;this.currentFile=null;this.keywordsVersionSeen=-1;this.updateRunId=0;this.keywordsVersionSeen=l.getKeywordsVersion(),this.updateDecorations(t)}async updateDecorations(t){let e=++this.updateRunId,i=l.getMarkdownViewForEditorView(t);if(!i||!i.file){e===this.updateRunId&&(this.decorations=P.Decoration.none);return}let n=i.file;this.currentFile=n,this.keywordsVersionSeen=l.getKeywordsVersion();let r=l.getSettingFolderForFile(n.path);if(!r){e===this.updateRunId&&(this.decorations=P.Decoration.none);return}if(l.isFileInFolder(n.path,r)){e===this.updateRunId&&(this.decorations=P.Decoration.none);return}let s=await l.extractKeywordsFromSettingFolder(r);if(e!==this.updateRunId)return;let a=new I.RangeSetBuilder,h=t.state.doc.toString(),c=[],d=l.getKeywordGroupMap(r),p=l.plugin.settings.highlightStyle.mode;for(let m of s){let f=m.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),w=new RegExp(f,"g"),y;for(;(y=w.exec(h))!==null;)c.push({from:y.index,to:y.index+m.length,keyword:m})}let g=p==="first"?(()=>{var w;let m=new Map,f=[...c].sort((y,M)=>y.from-M.from);for(let y of f){let M=(w=d.get(y.keyword))!=null?w:`kw::${y.keyword}`;m.has(M)||m.set(M,y)}return Array.from(m.values())})():c,u=[];g.sort((m,f)=>m.from-f.from);for(let m of g)u.push({from:m.from,to:m.to,decoration:P.Decoration.mark({class:"chinese-writer-highlight",attributes:{"data-cw-keyword":m.keyword,"data-cw-setting-folder":r}})});let v=l.collectPunctuationWarnings(h);for(let m of v)u.push({from:m,to:m+1,decoration:P.Decoration.mark({class:"chinese-writer-punctuation-warning"})});u.sort((m,f)=>m.from!==f.from?m.from-f.from:m.to-f.to);for(let m of u)a.add(m.from,m.to,m.decoration);this.decorations=a.finish(),t.dispatch({annotations:I.Transaction.addToHistory.of(!1)})}update(t){var a,o,h,c;let e=this.keywordsVersionSeen!==l.getKeywordsVersion(),i=l.getMarkdownViewForEditorView(t.view),n=(o=(a=i==null?void 0:i.file)==null?void 0:a.path)!=null?o:null,r=(c=(h=this.currentFile)==null?void 0:h.path)!=null?c:null,s=n!==r;(t.docChanged||e||s)&&this.updateDecorations(t.view)}destroy(){}},{decorations:t=>t.decorations})}updateStyles(){let l=this.plugin.settings.highlightStyle,t=l.borderWidth>0?"underline":"none",e=document.getElementById("chinese-writer-highlight-style");e&&e.remove();let i=document.createElement("style");i.id="chinese-writer-highlight-style",i.textContent=`
      .chinese-writer-highlight {
        background-color: ${l.backgroundColor};
        text-decoration-line: ${t} !important;
        text-decoration-style: ${l.borderStyle} !important;
        text-decoration-color: ${l.borderColor} !important;
        text-decoration-thickness: ${l.borderWidth}px !important;
        text-underline-offset: 8px !important;
        text-decoration-skip-ink: none !important;
        font-weight: ${l.fontWeight};
        font-style: ${l.fontStyle};
        color: ${l.color};
      }
    `,document.head.appendChild(i)}};var $=class extends F.Plugin{constructor(){super(...arguments);this.pluginDir="";this.settingsFilePath="";this.settingMenuRootEl=null;this.settingMenuChildEl=null;this.settingMenuCloseTimer=null;this.settingMenuExpandDirection="right";this.h3TitleCacheByFolder=new Map}async onload(){this.pluginDir=await this.resolvePluginDir(),this.settingsFilePath=`${this.pluginDir}/cw-setting.json`,await this.loadSettings(),this.parser=new A(this.app.vault),this.orderManager=new B(this.app,this.pluginDir),await this.orderManager.load(),await this.rebuildAllH3TitleCache(),this.highlightManager=new V(this),this.registerEditorExtension(this.highlightManager.createEditorExtension()),this.highlightManager.updateStyles(),this.registerView(C,t=>new N(t,this)),this.addCommand({id:"open-tree-view",name:"\u6253\u5F00\u6587\u6863\u6811\u89C6\u56FE",callback:()=>{this.activateView()}}),this.addRibbonIcon("book-type","\u4E2D\u6587\u5199\u4F5C",()=>{this.activateView()}),this.addSettingTab(new W(this.app,this)),this.register(()=>this.closeSettingSubmenus()),this.registerEvent(this.app.workspace.on("editor-menu",(t,e,i)=>{this.appendAddSettingEditorMenu(t,e,i)})),this.app.workspace.onLayoutReady(()=>{setTimeout(()=>{let t=this.app.workspace.getActiveViewOfType(F.MarkdownView);t&&t.file&&this.highlightManager.refreshCurrentEditor()},100)}),this.registerEvent(this.app.vault.on("modify",t=>{if(t instanceof F.TFile&&t.extension==="md"){this.smartUpdateView(),this.updateH3CacheForSettingFile(t.path);for(let e of this.settings.folderMappings)if(e.settingFolder&&t.path.startsWith(e.settingFolder+"/")){this.highlightManager.clearCache(),setTimeout(()=>{this.highlightManager.refreshCurrentEditor()},100);break}}})),this.registerEvent(this.app.vault.on("create",t=>{t instanceof F.TFile&&t.extension==="md"&&(this.syncOrderOnFileCreate(t),this.updateH3CacheForSettingFile(t.path))})),this.registerEvent(this.app.vault.on("delete",t=>{t instanceof F.TFile&&t.extension==="md"&&(this.syncOrderOnFileDelete(t),this.updateH3CacheForSettingFile(t.path))})),this.registerEvent(this.app.vault.on("rename",(t,e)=>{t instanceof F.TFile&&t.extension==="md"&&(this.syncOrderOnFileRename(t,e),this.updateH3CacheForSettingFile(e),this.updateH3CacheForSettingFile(t.path))})),this.app.workspace.onLayoutReady(()=>{this.activateView()})}onunload(){this.app.workspace.detachLeavesOfType(C)}async activateView(){let{workspace:t}=this.app,e=t.getLeavesOfType(C)[0];if(!e){let i=t.getRightLeaf(!1);i&&(await i.setViewState({type:C,active:!0}),e=i)}e&&t.revealLeaf(e)}async refreshView(){let t=this.app.workspace.getLeavesOfType(C);for(let e of t){let i=e.view;i instanceof N&&await i.refresh()}}async smartUpdateView(){let t=this.app.workspace.getLeavesOfType(C);for(let e of t){let i=e.view;i instanceof N&&await i.smartUpdate()}}async loadSettings(){let t=await this.readSettingsData();this.settings=Object.assign({},D,t),this.settings.highlightStyle&&(this.settings.highlightStyle=Object.assign({},D.highlightStyle,this.settings.highlightStyle)),this.settings.highlightPreviewStyle?this.settings.highlightPreviewStyle=Object.assign({},D.highlightPreviewStyle,this.settings.highlightPreviewStyle):this.settings.highlightPreviewStyle=Object.assign({},D.highlightPreviewStyle),this.settings.punctuationCheck?this.settings.punctuationCheck=Object.assign({},D.punctuationCheck,this.settings.punctuationCheck):this.settings.punctuationCheck=Object.assign({},D.punctuationCheck);let e=t==null?void 0:t.openInCurrentTab;!(typeof(t==null?void 0:t.openInNewTab)=="boolean")&&typeof e=="boolean"&&(this.settings.openInNewTab=!e),t&&t.targetFolder&&this.settings.folderMappings.length===0&&console.log("\u68C0\u6D4B\u5230\u65E7\u7248\u672C\u914D\u7F6E\uFF0C\u5DF2\u5220\u9664 targetFolder \u5B57\u6BB5\u3002\u8BF7\u5728\u8BBE\u7F6E\u4E2D\u914D\u7F6E\u65B0\u7684\u6587\u4EF6\u5939\u5BF9\u5E94\u5173\u7CFB\u3002")}async saveSettings(){let t=this.app.vault.adapter,e=this.settingsFilePath.substring(0,this.settingsFilePath.lastIndexOf("/"));e&&!await t.exists(e)&&await t.mkdir(e),await t.write(this.settingsFilePath,JSON.stringify(this.settings,null,2))}async resolvePluginDir(){var s,a,o;let t=this.app.vault.adapter,e=(s=this.manifest.dir)==null?void 0:s.trim(),i=(o=(a=this.manifest.id)==null?void 0:a.trim())!=null?o:"",n=i.toLowerCase(),r=Array.from(new Set([e,i?`.obsidian/plugins/${i}`:null,n?`.obsidian/plugins/${n}`:null].filter(h=>!!h&&h.length>0)));for(let h of r)if(await t.exists(`${h}/cw-setting.json`)||await t.exists(`${h}/cw-view-datas.json`)||await t.exists(`${h}/settings.json`)||await t.exists(`${h}/data.json`)||await t.exists(`${h}/view-datas.json`)||await t.exists(`${h}/order.json`))return h;for(let h of r)if(await t.exists(h))return h;return e&&e.length>0?e:`.obsidian/plugins/${n||"chinese-writer"}`}async readSettingsData(){let t=this.app.vault.adapter,e=`${this.pluginDir}/cw-setting.json`,i=`${this.pluginDir}/settings.json`,n=`${this.pluginDir}/data.json`;try{if(await t.exists(e)){let r=await t.read(e),s=JSON.parse(r);return s&&typeof s=="object"?s:{}}if(await t.exists(i)){let r=await t.read(i),s=JSON.parse(r);return s&&typeof s=="object"?s:{}}if(await t.exists(n)){let r=await t.read(n),s=JSON.parse(r);return s&&typeof s=="object"?s:{}}}catch(r){console.error("Failed to read settings data:",r)}return{}}async openFileWithSettings(t,e){var a;let i=this.settings.openInNewTab,n=(a=e==null?void 0:e.revealWhenNewTab)!=null?a:!1,r=this.findOpenedLeafForFile(t.path);if(r)return(!i||n)&&this.app.workspace.revealLeaf(r),r;if(!i){let o=this.getPreferredCurrentLeaf();return o?(await o.openFile(t,{active:!0}),o):null}let s=this.app.workspace.getLeaf("tab");return await s.openFile(t,{active:n}),s}getPreferredCurrentLeaf(){let t=this.app.workspace.getActiveViewOfType(F.MarkdownView);if(t)return t.leaf;let e=this.app.workspace.getLeavesOfType("markdown");return e.length>0?e[0]:this.app.workspace.getMostRecentLeaf()}findOpenedLeafForFile(t){var i,n;let e=this.app.workspace.getLeavesOfType("markdown");for(let r of e){let s=r.getViewState();if((typeof((i=s.state)==null?void 0:i.file)=="string"?s.state.file:null)===t)return r;let o=r.view;if(o instanceof F.MarkdownView&&((n=o.file)==null?void 0:n.path)===t)return r}return null}appendAddSettingEditorMenu(t,e,i){var o;let r=e.getSelection().replace(/\s+/g," ").trim();if(!r)return;let s=(o=i==null?void 0:i.file)!=null?o:this.app.workspace.getActiveFile();if(!(s instanceof F.TFile))return;let a=this.highlightManager.getSettingFolderForFile(s.path);a&&(this.hasH3InSettingFolder(a,r)||(t.addSeparator(),t.addItem(h=>{h.setTitle("\u6DFB\u52A0\u8BBE\u5B9A"),h.setIcon("book-plus"),h.onClick(d=>{this.openSettingFirstLevelMenu(d.clientX,d.clientY,a,r,null)});let c=h==null?void 0:h.dom;if(c){let d=c.createSpan({cls:"cw-context-submenu-arrow"});(0,F.setIcon)(d,"chevron-right"),c.addEventListener("mouseenter",()=>{let p=c.getBoundingClientRect();this.openSettingFirstLevelMenu(p.right-2,p.top,a,r,p)}),c.addEventListener("mouseleave",()=>this.scheduleCloseSettingSubmenus())}})))}async collectSettingFileOptions(t){let e=this.parser.getMarkdownFilesInFolder(t),i=this.orderManager.getFileOrder(),n=[...e].sort((s,a)=>{let o=i.indexOf(s.path),h=i.indexOf(a.path);return o===-1&&h===-1?s.path.localeCompare(a.path):o===-1?1:h===-1?-1:o-h}),r=[];for(let s of n){let a=await this.parser.parseFile(s);if(!a)continue;let o=[];for(let h of a.h1List)o.push({label:h.text,lineNumber:h.lineNumber});r.push({file:s,h1Options:o})}return r}async openSettingFirstLevelMenu(t,e,i,n,r){this.clearCloseSettingSubmenusTimer();let s=await this.collectSettingFileOptions(i);if(s.length===0){this.closeSettingSubmenus(),new F.Notice("\u8BE5\u8BBE\u5B9A\u5E93\u6CA1\u6709\u53EF\u7528\u7684 H1 \u9009\u9879");return}this.settingMenuRootEl||(this.settingMenuRootEl=this.createSettingSubmenuContainer("cw-setting-submenu-root")),this.settingMenuRootEl.empty(),this.settingMenuRootEl.removeClass("is-expand-left"),this.settingMenuRootEl.removeClass("is-expand-right");let a=[];for(let c of s){let d=this.settingMenuRootEl.createDiv({cls:"cw-setting-submenu-item"}),p=d.createSpan({cls:"cw-setting-submenu-item-icon"});(0,F.setIcon)(p,"file-text"),d.createSpan({text:c.file.basename,cls:"cw-setting-submenu-label"});let g=c.h1Options.length>0,u=d.createSpan({cls:"cw-setting-submenu-item-arrow"});(0,F.setIcon)(u,"chevron-right"),a.push({el:u,hasChildren:g}),g||d.addClass("is-disabled"),d.addEventListener("mouseenter",()=>{if(this.clearCloseSettingSubmenusTimer(),g){let v=d.getBoundingClientRect();this.openSettingSecondLevelMenu(v,c,n)}else this.closeSettingChildMenu()}),d.addEventListener("mouseleave",()=>this.scheduleCloseSettingSubmenus())}let o=r!=null?r:this.createPointAnchorRect(t,e);this.settingMenuExpandDirection=this.pickMenuExpandDirection(this.settingMenuRootEl,o);let h=this.settingMenuExpandDirection==="left";this.settingMenuRootEl.toggleClass("is-expand-left",h),this.settingMenuRootEl.toggleClass("is-expand-right",!h);for(let c of a)c.hasChildren&&(c.el.empty(),(0,F.setIcon)(c.el,h?"chevron-left":"chevron-right"));r?this.placeMenuBesideAnchor(this.settingMenuRootEl,r,2,this.settingMenuExpandDirection):this.placeMenuBesideAnchor(this.settingMenuRootEl,o,2,this.settingMenuExpandDirection),this.settingMenuRootEl.style.display="block"}openSettingSecondLevelMenu(t,e,i){this.clearCloseSettingSubmenusTimer(),this.settingMenuChildEl||(this.settingMenuChildEl=this.createSettingSubmenuContainer("cw-setting-submenu-child")),this.settingMenuChildEl.empty();for(let n of e.h1Options){let r=this.settingMenuChildEl.createDiv({cls:"cw-setting-submenu-item"}),s=r.createSpan({cls:"cw-setting-submenu-item-icon"});(0,F.setIcon)(s,"heading-1"),r.createSpan({text:n.label,cls:"cw-setting-submenu-label"}),r.addEventListener("mouseenter",()=>this.clearCloseSettingSubmenusTimer()),r.addEventListener("mouseleave",()=>this.scheduleCloseSettingSubmenus()),r.addEventListener("click",()=>{this.appendSelectionAsH2(e.file,n.lineNumber,i)})}this.placeMenuBesideAnchor(this.settingMenuChildEl,t,2,this.settingMenuExpandDirection),this.settingMenuChildEl.style.display="block"}async appendSelectionAsH2(t,e,i){var h,c;let n=i.replace(/\s+/g," ").trim();if(!n)return;let s=(await this.app.vault.read(t)).split(`
`),a=Math.max(0,Math.min(e,s.length-1)),o=s.length;for(let d=a+1;d<s.length;d++){let p=(c=(h=s[d])==null?void 0:h.trim())!=null?c:"";if(p.startsWith("# ")&&!p.startsWith("## ")){o=d;break}}s.splice(o,0,`## ${n}`),await this.app.vault.modify(t,s.join(`
`)),this.updateH3CacheForSettingFile(t.path),this.highlightManager.clearCache(),await this.smartUpdateView(),new F.Notice(`\u5DF2\u6DFB\u52A0\u5230\uFF1A${t.basename}`),this.closeSettingSubmenus()}placeMenuWithinViewport(t,e,i){t.style.visibility="hidden",t.style.display="block",t.style.left="0px",t.style.top="0px";let n=t.getBoundingClientRect(),r=8,s=Math.min(Math.max(r,e),Math.max(r,window.innerWidth-n.width-r)),a=Math.min(Math.max(r,i),Math.max(r,window.innerHeight-n.height-r));t.style.left=`${s}px`,t.style.top=`${a}px`,t.style.visibility="visible"}placeMenuBesideAnchor(t,e,i,n){t.style.visibility="hidden",t.style.display="block",t.style.left="0px",t.style.top="0px";let r=t.getBoundingClientRect(),s=8,a=n==="right"?e.right+i:e.left-r.width-i;(a+r.width>window.innerWidth-s||a<s)&&(a=n==="right"?e.left-r.width-i:e.right+i),(a+r.width>window.innerWidth-s||a<s)&&(a=e.left-r.width-i),a=Math.min(Math.max(s,a),Math.max(s,window.innerWidth-r.width-s));let o=e.top;o+r.height>window.innerHeight-s&&(o=window.innerHeight-r.height-s),o=Math.max(s,o),t.style.left=`${a}px`,t.style.top=`${o}px`,t.style.visibility="visible"}pickMenuExpandDirection(t,e){let n=this.measureMenuWidth(t),r=this.measureMenuClassWidth("cw-setting-submenu cw-setting-submenu-child"),s=n+2+r,a=window.innerWidth-e.right-8,o=e.left-8,h=a>=s,c=o>=s;return h&&c||h?"right":c?"left":a>=o?"right":"left"}measureMenuWidth(t){t.style.visibility="hidden",t.style.display="block",t.style.left="0px",t.style.top="0px";let e=t.getBoundingClientRect().width;return t.style.display="none",t.style.visibility="visible",e}measureMenuClassWidth(t){let e=document.body.createDiv({cls:t});e.style.visibility="hidden",e.style.display="block",e.style.left="0px",e.style.top="0px";let i=e.getBoundingClientRect().width;return e.remove(),i}createPointAnchorRect(t,e){return new DOMRect(t,e,0,0)}createSettingSubmenuContainer(t){let e=document.body.createDiv({cls:`cw-setting-submenu ${t}`});return e.addEventListener("mouseenter",()=>this.clearCloseSettingSubmenusTimer()),e.addEventListener("mouseleave",()=>this.scheduleCloseSettingSubmenus()),e}closeSettingChildMenu(){this.settingMenuChildEl&&(this.settingMenuChildEl.style.display="none",this.settingMenuChildEl.empty())}closeSettingSubmenus(){this.clearCloseSettingSubmenusTimer(),this.settingMenuRootEl&&(this.settingMenuRootEl.remove(),this.settingMenuRootEl=null),this.settingMenuChildEl&&(this.settingMenuChildEl.remove(),this.settingMenuChildEl=null)}scheduleCloseSettingSubmenus(){this.clearCloseSettingSubmenusTimer(),this.settingMenuCloseTimer=window.setTimeout(()=>this.closeSettingSubmenus(),180)}clearCloseSettingSubmenusTimer(){this.settingMenuCloseTimer!==null&&(window.clearTimeout(this.settingMenuCloseTimer),this.settingMenuCloseTimer=null)}async rebuildAllH3TitleCache(){this.h3TitleCacheByFolder.clear();for(let t of this.settings.folderMappings)t.settingFolder&&await this.rebuildH3TitleCacheForFolder(t.settingFolder)}async rebuildH3TitleCacheForFolder(t){let e=new Set,i=this.parser.getMarkdownFilesInFolder(t);for(let n of i){let s=(await this.app.vault.read(n)).split(`
`);for(let a of s){let o=a.trim(),h=o.startsWith("## ")&&!o.startsWith("### "),c=o.startsWith("### ")&&!o.startsWith("#### ");if(h||c){let d=h?3:4,p=o.slice(d).replace(/\s+/g," ").trim();p&&e.add(p)}}}this.h3TitleCacheByFolder.set(t,e)}hasH3InSettingFolder(t,e){let i=this.h3TitleCacheByFolder.get(t);if(!i)return!1;let n=e.replace(/\s+/g," ").trim();return i.has(n)}updateH3CacheForSettingFile(t){let e=this.findSettingFolderByFilePath(t);e&&this.rebuildH3TitleCacheForFolder(e)}findSettingFolderByFilePath(t){for(let e of this.settings.folderMappings)if(e.settingFolder&&t.startsWith(`${e.settingFolder}/`))return e.settingFolder;return null}async syncOrderOnFileCreate(t){let e=null;for(let n of this.settings.folderMappings)if(n.settingFolder&&t.path.startsWith(n.settingFolder+"/")){e=n.settingFolder;break}if(!e){await this.smartUpdateView();return}let i=this.orderManager.getFileOrder();i.length===0?i=this.parser.getMarkdownFilesInFolder(e).map(r=>r.path):i.includes(t.path)||i.push(t.path),await this.orderManager.setFileOrder(i),setTimeout(()=>{this.smartUpdateView()},400)}async syncOrderOnFileDelete(t){let e=null;for(let r of this.settings.folderMappings)if(r.settingFolder&&t.path.startsWith(r.settingFolder+"/")){e=r.settingFolder;break}if(!e){await this.smartUpdateView();return}let i=this.orderManager.getFileOrder();i.length===0&&(i=this.parser.getMarkdownFilesInFolder(e).map(s=>s.path));let n=i.indexOf(t.path);n!==-1&&(i.splice(n,1),await this.orderManager.setFileOrder(i)),setTimeout(()=>{this.smartUpdateView()},400)}async syncOrderOnFileRename(t,e){let i=null,n=!1,r=!1;for(let a of this.settings.folderMappings)a.settingFolder&&(e.startsWith(a.settingFolder+"/")&&(n=!0,i=a.settingFolder),t.path.startsWith(a.settingFolder+"/")&&(r=!0,i=a.settingFolder));if(!n&&!r){await this.smartUpdateView();return}if(!i){await this.smartUpdateView();return}let s=this.orderManager.getFileOrder();if(s.length===0)s=this.parser.getMarkdownFilesInFolder(i).map(o=>o.path);else{let a=s.indexOf(e);a!==-1?r?s[a]=t.path:s.splice(a,1):r&&s.push(t.path)}await this.orderManager.setFileOrder(s),setTimeout(()=>{this.smartUpdateView()},400)}};
